- name: Patch system and notify
  hosts: all
  become: yes
  vars:
    update_script_path: /tmp/update.sh
    notify_script_path: /tmp/notify.sh

  tasks:

    - name: üì§ Copy update script to remote host
      copy:
        src: update.sh
        dest: "{{ update_script_path }}"
        mode: '0755'
        diff: false  # ‚úÖ Suppress diff output

    - name: ‚ñ∂Ô∏è Run update script asynchronously
      shell: bash "{{ update_script_path }}"
      async: 600              # ‚è≥ Run up to 10 minutes
      poll: 10                # üîÅ Check every 10 seconds
      register: update_result
      ignore_errors: yes

    - name: üßæ Print update script result
      debug:
        var: update_result

    - name: ‚ùå Fail if update script failed
      fail:
        msg: >-
          ‚ö†Ô∏è Update script failed.
          RC: {{ update_result.rc }}
          STDOUT: {{ update_result.stdout | default('') }}
          STDERR: {{ update_result.stderr | default('') }}
      when: update_result.rc != 0

    - name: üì§ Copy notify script to remote host
      copy:
        src: notify.sh
        dest: "{{ notify_script_path }}"
        mode: '0755'
        diff: false  # ‚úÖ Suppress diff output

    - name: ‚ñ∂Ô∏è Run notify script
      shell: bash "{{ notify_script_path }}"
      register: notify_result
      ignore_errors: yes

    - name: üßæ Print notify script result
      debug:
        var: notify_result

    - name: ‚ùå Fail if notify script failed
      fail:
        msg: >-
          ‚ö†Ô∏è Notify script failed.
          RC: {{ notify_result.rc }}
          STDOUT: {{ notify_result.stdout | default('') }}
          STDERR: {{ notify_result.stderr | default('') }}
      when: notify_result.rc != 0
